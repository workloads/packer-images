---

- name: "Provision Packer Image for Target `{{ packer_builder_type }}`"
  hosts: default
  become: true
  vars:
    ansible_required_version: "2.13.3"

  vars_files:
    - "{{ ConfigFile }}"

  pre_tasks:
    # see https://docs.ansible.com/ansible/latest/collections/ansible/builtin/fail_module.html
    - name: Verify Ansible Version meets requirements
      ansible.builtin.fail:
        msg: "Need v{{ ansible_required_version }}, got v{{ ansible_version.full }}"
      when: ansible_version.full < ansible_required_version

    # see https://docs.ansible.com/ansible/latest/collections/ansible/builtin/debug_module.html
    - name: Print `ansible_env`
      ansible.builtin.debug:
        var: ansible_env
      when:
        - enable_debug_statements is defined
        - enable_debug_statements

    # see https://docs.ansible.com/ansible/latest/collections/ansible/builtin/debug_module.html
    - name: Print `ansible_facts`
      ansible.builtin.debug:
        var: ansible_facts
      when:
        - enable_debug_statements is defined
        - enable_debug_statements
        - enable_facts_statement

  roles:
    - role: ansible-lockdown.ubuntu22_cis
      when:
        # see https://releases.ubuntu.com/22.04/
        ansible_distribution == 'Ubuntu'
        and ansible_distribution_release == 'jammy'
        and enable_cis_hardening == true

  tasks:
    # see https://docs.ansible.com/ansible/latest/collections/ansible/builtin/include_tasks_module.html
    - name: Manage OS Operations
      ansible.builtin.include_tasks:
        file: os.yml
      when:
        - os is defined and os.enabled

    # see https://docs.ansible.com/ansible/latest/collections/ansible/builtin/include_tasks_module.html
    - name: Manage Tooling Tasks
      ansible.builtin.include_tasks:
        file: tools.yml
      when:
        - tools is defined

    # see https://docs.ansible.com/ansible/latest/collections/ansible/builtin/include_tasks_module.html
    - name: Manage Cleanup Tasks
      ansible.builtin.include_tasks:
        file: post_cleanup.yml
      when:
        - post_cleanup is defined and post_cleanup.enabled
